rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    function isSignedIn() {
      return request.auth != null;
    }
    
    function isUser(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    function isAdmin() {
      // Un usuari és admin si el seu email és el del compte de servei
      // O si el seu document d'usuari a la col·lecció 'users' té el camp role == 'Admin'.
      return request.auth.token.email == "firebase-service-account@local-dev.iam.gserviceaccount.com"
             || get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'Admin';
    }

    match /app_settings/{setting} {
      allow read: if true;
      allow write: if isSignedIn();
    }
    
    match /users/{userId} {
       // Allow any client to read user profiles (for names, emails, etc.)
       allow read: if true;
       // Only allow a user to write to their own profile
       allow write: if isUser(userId) || isAdmin();
    }
    
    match /actions/{actionId} {
      // LIST: Allow admins or signed-in users to perform queries.
      allow list: if isAdmin() || isSignedIn();
      
      // READ: Admins can read everything. Other users must be in the 'readers' array.
      allow read: if isAdmin() || (isSignedIn() && request.auth.token.email in resource.data.readers);
      
      // CREATE: Any signed-in user can create an action. The client-side logic will set initial permissions.
      allow create: if isSignedIn();
      
      // UPDATE: Only users in the 'authors' array can update the document.
      allow update: if isSignedIn() && (isAdmin() || request.auth.token.email in resource.data.authors);
      
      // DELETE: Not allowed for now. Actions should be 'Anulada' instead.
      allow delete: if false;
    }

    // Default deny rule for master data collections unless specified otherwise
    match /ambits/{docId} { allow read, write: if isSignedIn(); }
    match /origins/{docId} { allow read, write: if isSignedIn(); }
    match /classifications/{docId} { allow read, write: if isSignedIn(); }
    match /locations/{docId} { allow read, write: if isSignedIn(); }
    match /responsibilityRoles/{docId} { allow read, write: if isSignedIn(); }
    match /permissionMatrix/{docId} { allow read, write: if isSignedIn(); }


    match /{document=**} {
      allow read, write: if false; // Default deny all for any other path
    }
  }
}
